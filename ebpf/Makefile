


# =============================================================================
# æ–‡ä»¶: ebpf/Makefile
# æè¿°: eBPF ç¨‹åºç¼–è¯‘
# =============================================================================

CLANG ?= clang
LLC ?= llc
BPFTOOL ?= bpftool
GO ?= go

# ç¼–è¯‘ç›®æ ‡
TARGETS := xdp_phantom.o tc_phantom.o

# ç¼–è¯‘é€‰é¡¹
ARCH := $(shell uname -m | sed 's/x86_64/x86/' | sed 's/aarch64/arm64/')
CFLAGS := -O2 -g -Wall -Werror
CFLAGS += -target bpf
CFLAGS += -D__TARGET_ARCH_$(ARCH)
CFLAGS += -I/usr/include/$(shell uname -m)-linux-gnu

# å†…æ ¸å¤´æ–‡ä»¶
KERNEL_HEADERS := $(shell find /usr/include -name "bpf_helpers.h" -printf "%h" 2>/dev/null | head -1)
ifneq ($(KERNEL_HEADERS),)
CFLAGS += -I$(KERNEL_HEADERS)
endif

# libbpf å¤´æ–‡ä»¶
LIBBPF_HEADERS := $(shell pkg-config --cflags libbpf 2>/dev/null)
ifneq ($(LIBBPF_HEADERS),)
CFLAGS += $(LIBBPF_HEADERS)
endif

.PHONY: all clean vmlinux generate install

all: vmlinux.h $(TARGETS)
	@echo "âœ… eBPF ç¨‹åºç¼–è¯‘å®Œæˆ"

# ç”Ÿæˆ vmlinux.h (BTF)
vmlinux.h:
	@if [ -f /sys/kernel/btf/vmlinux ]; then \
		echo "ğŸ“¦ ç”Ÿæˆ vmlinux.h..."; \
		$(BPFTOOL) btf dump file /sys/kernel/btf/vmlinux format c > $@; \
	else \
		echo "âš ï¸  BTF ä¸å¯ç”¨ï¼Œåˆ›å»ºæœ€å°å¤´æ–‡ä»¶"; \
		echo "// Minimal vmlinux.h" > $@; \
	fi

# ç¼–è¯‘ XDP ç¨‹åº
xdp_phantom.o: xdp_phantom.c phantom_common.h vmlinux.h
	@echo "ğŸ”¨ ç¼–è¯‘ $<..."
	$(CLANG) $(CFLAGS) -c $< -o $@
	@echo "  âœ“ $@"

# ç¼–è¯‘ TC ç¨‹åº
tc_phantom.o: tc_phantom.c phantom_common.h vmlinux.h
	@echo "ğŸ”¨ ç¼–è¯‘ $<..."
	$(CLANG) $(CFLAGS) -c $< -o $@
	@echo "  âœ“ $@"

# ç”Ÿæˆ Go ç»‘å®š
generate: $(TARGETS)
	@echo "ğŸ“¦ ç”Ÿæˆ Go ç»‘å®š..."
	$(GO) generate ./...

# å®‰è£…åˆ°ç³»ç»Ÿ
install: $(TARGETS)
	@echo "ğŸ“¦ å®‰è£… eBPF ç¨‹åº..."
	sudo mkdir -p /opt/phantom/ebpf
	sudo cp $(TARGETS) /opt/phantom/ebpf/
	sudo cp phantom_common.h /opt/phantom/ebpf/
	@echo "âœ… å®‰è£…å®Œæˆ"

# åŠ è½½ XDP ç¨‹åº (æµ‹è¯•ç”¨)
load-xdp: xdp_phantom.o
	@echo "ğŸ“¦ åŠ è½½ XDP ç¨‹åºåˆ° eth0..."
	sudo ip link set dev eth0 xdp obj $< sec xdp

# å¸è½½ XDP ç¨‹åº
unload-xdp:
	@echo "ğŸ“¦ å¸è½½ XDP ç¨‹åº..."
	sudo ip link set dev eth0 xdp off

# åŠ è½½ TC ç¨‹åº
load-tc: tc_phantom.o
	@echo "ğŸ“¦ åŠ è½½ TC ç¨‹åº..."
	sudo tc qdisc add dev eth0 clsact 2>/dev/null || true
	sudo tc filter add dev eth0 egress bpf da obj $< sec tc
	sudo tc filter add dev eth0 ingress bpf da obj $< sec tc

# å¸è½½ TC ç¨‹åº
unload-tc:
	@echo "ğŸ“¦ å¸è½½ TC ç¨‹åº..."
	sudo tc filter del dev eth0 egress 2>/dev/null || true
	sudo tc filter del dev eth0 ingress 2>/dev/null || true

# æŸ¥çœ‹ç¨‹åºä¿¡æ¯
info: $(TARGETS)
	@for f in $(TARGETS); do \
		echo "=== $$f ==="; \
		llvm-objdump -S $$f | head -50; \
		echo ""; \
	done

# æ¸…ç†
clean:
	rm -f $(TARGETS) vmlinux.h
	@echo "âœ… æ¸…ç†å®Œæˆ"


